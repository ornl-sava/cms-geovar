(function(a){function b(a,b){return typeof a=="function"?a.call(b):a}function d(b,d){this.$element=a(b),this.options=d,this.enabled=!0,this.fixTitle(),c(this)}var c=function(){function d(){for(var a=0;a<c.length;){var b=c[a];b.options.gcInterval===0||b.$element.closest("body").length===0?(b.hoverState="out",b.hide(),c.splice(a,1)):a++}}function e(){b=setTimeout(function(){d(),e()},a)}var a,b=null,c=[];return function(d){if(d.options.gcInterval===0)return;b&&d.options.gcInterval<a&&(clearTimeout(b),b=null,a=d.options.gcInterval),c.push(d),b||e()}}();d.prototype={show:function(){var c=this.getTitle();if(c&&this.enabled){var d=this.tip();d.find(".tipsy-inner")[this.options.html?"html":"text"](c),d[0].className="tipsy",d.remove().css({top:0,left:0,visibility:"hidden",display:"block"}).prependTo(document.body);var e=a.extend({},this.$element.offset(),{width:this.$element[0].offsetWidth||0,height:this.$element[0].offsetHeight||0});if(typeof this.$element[0].nearestViewportElement=="object"){var f=this.$element[0],g=f.getBoundingClientRect();e.width=g.width,e.height=g.height}var h=d[0].offsetWidth,i=d[0].offsetHeight,j=b(this.options.gravity,this.$element[0]),k;switch(j.charAt(0)){case"n":k={top:e.top+e.height+this.options.offset,left:e.left+e.width/2-h/2};break;case"s":k={top:e.top-i-this.options.offset,left:e.left+e.width/2-h/2};break;case"e":k={top:e.top+e.height/2-i/2,left:e.left-h-this.options.offset};break;case"w":k={top:e.top+e.height/2-i/2,left:e.left+e.width+this.options.offset}}j.length==2&&(j.charAt(1)=="w"?k.left=e.left+e.width/2-15:k.left=e.left+e.width/2-h+15),d.css(k).addClass("tipsy-"+j),d.find(".tipsy-arrow")[0].className="tipsy-arrow tipsy-arrow-"+j.charAt(0),this.options.className&&d.addClass(b(this.options.className,this.$element[0])),this.options.fade?d.stop().css({opacity:0,display:"block",visibility:"visible"}).animate({opacity:this.options.opacity}):d.css({visibility:"visible",opacity:this.options.opacity});var l=this,m=function(a){return function(){l.$tip.stop(),l.tipHovered=a,a||(l.options.delayOut===0&&l.options.trigger!="manual"?l.hide():setTimeout(function(){l.hoverState=="out"&&l.hide()},l.options.delayOut))}};d.hover(m(!0),m(!1))}},hide:function(){this.options.fade?this.tip().stop().fadeOut(function(){a(this).remove()}):this.tip().remove()},fixTitle:function(){var a=this.$element;(a.attr("title")||typeof a.attr("original-title")!="string")&&a.attr("original-title",a.attr("title")||"").removeAttr("title"),typeof a.context.nearestViewportElement=="object"&&a.children("title").length&&a.append("<original-title>"+(a.children("title").text()||"")+"</original-title>").children("title").remove()},getTitle:function(){var a,b=this.$element,c=this.options;this.fixTitle();if(typeof c.title=="string"){var d=c.title=="title"?"original-title":c.title;b.children(d).length?a=b.children(d).html():(a=b.attr(d),typeof a=="undefined"&&(a=""))}else typeof c.title=="function"&&(a=c.title.call(b[0]));return a=(""+a).replace(/(^\s*|\s*$)/,""),a||c.fallback},tip:function(){return this.$tip||(this.$tip=a('<div class="tipsy"></div>').html('<div class="tipsy-arrow"></div><div class="tipsy-inner"></div>')),this.$tip},validate:function(){this.$element[0].parentNode||(this.hide(),this.$element=null,this.options=null)},enable:function(){this.enabled=!0},disable:function(){this.enabled=!1},toggleEnabled:function(){this.enabled=!this.enabled}},a.fn.tipsy=function(b){function c(c){var e=a.data(c,"tipsy");return e||(e=new d(c,a.fn.tipsy.elementOptions(c,b)),a.data(c,"tipsy",e)),e}function e(){var a=c(this);a.hoverState="in",b.delayIn===0?a.show():(a.fixTitle(),setTimeout(function(){a.hoverState=="in"&&a.show()},b.delayIn))}function f(){var a=c(this);a.hoverState="out";if(b.delayOut===0)a.hide();else{var d=function(){(!a.tipHovered||!b.hoverlock)&&a.hoverState=="out"&&a.hide()};setTimeout(d,b.delayOut)}}if(b===!0)return this.data("tipsy");if(typeof b=="string")return a(this).each(function(c,d){a(d).data("tipsy")&&(tipsy=a(d).data("tipsy"),tipsy[b]())}),this;b=a.extend({},a.fn.tipsy.defaults,b),b.hoverlock&&b.delayOut===0&&(b.delayOut=100),b.live||this.each(function(){c(this)});if(b.trigger!="manual"){var g=b.live?"live":"bind",h=b.trigger=="hover"?"mouseenter":"focus",i=b.trigger=="hover"?"mouseleave":"blur";this[g](h,e)[g](i,f)}return this},a.fn.tipsy.defaults={className:null,delayIn:0,delayOut:0,fade:!1,fallback:"",gcInterval:0,gravity:"n",html:!1,live:!1,offset:0,opacity:.8,title:"title",trigger:"hover",hoverlock:!1},a.fn.tipsy.elementOptions=function(b,c){return a.metadata?a.extend({},c,a(b).metadata()):c},a.fn.tipsy.autoNS=function(){return a(this).offset().top>a(document).scrollTop()+a(window).height()/2?"s":"n"},a.fn.tipsy.autoWE=function(){return a(this).offset().left>a(document).scrollLeft()+a(window).width()/2?"e":"w"},a.fn.tipsy.autoBounds=function(b,c){return function(){var d={ns:c[0],ew:c.length>1?c[1]:!1},e=a(document).scrollTop()+b,f=a(document).scrollLeft()+b,g=a(this);return g.offset().top<e&&(d.ns="n"),g.offset().left<f&&(d.ew="w"),a(window).width()+a(document).scrollLeft()-g.offset().left<b&&(d.ew="e"),a(window).height()+a(document).scrollTop()-g.offset().top<b&&(d.ns="s"),d.ns+(d.ew?d.ew:"")}}})(jQuery),"use strict",function(){function l(a){var b=[2007,2008,2009,2010],d=[],e=[],h={},i={},j={},k=0;for(var l=0;l<a.length;l++){var m=a[l],n=m.Year,o=m.Locale,p=_.find(c,function(a){return a.stateAbbr===o}),q=+p.code,r=p.name;for(var s in m)if(s!=="Year"&&s!=="Locale"){var t;if(m[s]){var u=m[s].replace(/[^\d\.\-\ ]/g,"");t=parseFloat(u)}else t=NaN;if(!_.contains(e,s)){var v={name:s,id:k,values:[{year:n,indicatorId:k,indicator:s,locales:[{id:q,name:r,value:t}]}]},w=d.push(v);h[s]=w-1,e.push(s),i[s]=[n],j[s]={},j[s][n]=0,g.push({id:k,name:s}),k++}else if(!_.contains(i[s],n)){var x=d[h[s]].values.push({year:n,indicatorId:_.find(g,function(a){return a.name===s}).id,indicator:s,locales:[{id:q,name:r,value:t}]});i[s].push(n),j[s][n]=x-1}else{var y=d[h[s]].values,z=y[j[s][n]];z.locales.push({id:q,name:r,value:t})}}}var A=d3.range(9).map(function(a){return"q"+a+"-9"});return _.each(d,function(a){var b=d3.min(a.values,function(a){return d3.min(a.locales,function(a){return a.value})}),c=d3.max(a.values,function(a){return d3.max(a.locales,function(a){return a.value})}),d=d3.scale.quantize().range(A).domain([b,c]);f[a.name]=d}),d}function m(a,b,f,g,j){c=j,d=topojson.object(g,g.objects.states).geometries,e=topojson.mesh(g,g.objects.states,function(a,b){return a.id!==b.id});var k=l(f),m=d3.select("#previews").selectAll(".row").data(k).enter().append("div").attr("class","row");m.each(n),$(".rowLabel").tipsy({gravity:"s",fade:!0,delayIn:500}),$(".states").tipsy({gravity:$.fn.tipsy.autoNS,html:!0}),h.stop(),console.log("Total load time: "+(Date.now()-i)/1e3+" seconds.")}function n(c,d){var e=d3.select(this),f=c.name.length>90?c.name.substr(0,90)+" ...":c.name;e.append("div").attr("class","rowLabel").attr("title",c.name).html(f);var g=e.selectAll(".preview").data(c.values).enter().append("div").attr("class",function(a){return"indicator-"+ +a.id+" preview"}).style("width",a).style("height",b),h=g.append("svg").attr("width",a).attr("height",b),i=h.append("g");i.each(o)}function o(c,g){var h={};_.each(c.locales,function(a){h[+a.id]=+a.value});var i=d3.format(","),j=d3.select(this);j.append("rect").attr("width",a).attr("height",b).attr("class","mapBg");var l=j.append("g");l.append("text").text(function(a){return c.year}).attr("class","mapTitle").attr("text-anchor","middle").attr("x",a/2).attr("dy","1.3em"),l.selectAll("path").data(d).enter().append("path").attr("d",k).attr("data-indicator",c.indicator).attr("data-indicator-id",c.indicatorId).attr("data-year",c.year).attr("class",function(a){var b=f[c.indicator],d=b(h[+a.id]);return"states indicator-"+c.indicatorId+"-state-"+ +a.id+" "+(typeof d!==undefined?d:"")}).attr("title",function(a){var b=_.find(c.locales,function(b){return a.id===b.id}),d=f[c.indicator].domain();return"<big><strong>"+b.name+" &raquo; "+i(b.value)+"</strong></big><br />"+"min: "+d[0]+" / max: "+d[1]+"<br />"+"<small>"+c.indicator+"</small>"}).on("mouseover",function(a){var b=d3.select(this).attr("data-indicator-id");p("over",b,+a.id)}).on("mouseout",function(a){var b=d3.select(this).attr("data-indicator-id");p("out",b,+a.id)}),l.append("path").datum(e).attr("d",k).attr("class","states-boundary")}function p(a,b,c){d3.selectAll(".indicator-"+b+"-state-"+c).style("fill",a==="over"?"#b0d912":null)}var a=190,b=135,c,d,e,f={},g=[],h=new Spinner({top:100,radius:15,length:16,width:6}),i=Date.now(),j=d3.geo.albersUsa().scale(a+20).translate([(a+20)/2,b/2+10]),k=d3.geo.path().projection(j);h.spin(document.getElementById("vis")),queue().defer(d3.csv,"data/national-2007-2010-trimmed.csv").defer(d3.csv,"data/states-2007-2010-trimmed.csv").defer(d3.json,"data/us-small.json").defer(d3.json,"data/state-codes.json").await(m)}();